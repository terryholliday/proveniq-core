%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#1a1a2e', 'primaryTextColor': '#eee', 'primaryBorderColor': '#4a9eff', 'lineColor': '#4a9eff'}}}%%

sequenceDiagram
    autonumber
    
    participant C as ğŸ“± Client
    participant E as â˜ï¸ Edge
    participant M as ğŸ›¡ï¸ Middleware
    participant CO as âš¡ Core
    participant LE as ğŸ’¾ Ledger
    participant LO as ğŸ”— Locker
    participant V as âœ… Verify
    participant DLQ as ğŸ“¬ DLQ

    Note over C,DLQ: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HAPPY PATH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    rect rgb(34, 197, 94, 0.1)
        C->>E: POST /api/assets
        Note right of C: t=0ms
        
        E->>M: Forward request
        Note right of E: t=15ms (TLS)
        
        M->>M: Rate limit âœ“
        M->>M: Auth check âœ“
        Note right of M: t=35ms
        
        M->>CO: Authorized request
        
        CO->>CO: Validate payload
        CO->>CO: Begin transaction
        Note right of CO: t=45ms
        
        CO->>LE: createAssetRecord()
        LE-->>CO: {assetId} âœ“
        Note right of LE: t=75ms (+30ms)
        
        CO->>LO: linkPhysicalAsset()
        LO-->>CO: {lockerId} âœ“
        Note right of LO: t=275ms (+200ms)
        
        CO->>CO: Commit transaction
        CO->>V: queueVerification()
        V-->>CO: {verificationId} âœ“
        Note right of V: t=290ms
        
        CO->>CO: Audit log
        CO-->>C: 201 Created
        Note right of C: t=300ms âœ…
    end

    Note over C,DLQ: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FAILURE PATH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    rect rgb(239, 68, 68, 0.1)
        C->>E: POST /api/assets
        Note right of C: t=0ms
        
        E->>M: Forward request
        M->>M: Rate limit âœ“
        M->>M: Auth check âœ“
        M->>CO: Authorized request
        
        CO->>CO: Validate payload
        CO->>CO: Begin transaction
        
        CO->>LE: createAssetRecord()
        LE-->>CO: {assetId} âœ“
        Note right of LE: Ledger OK
        
        CO->>LO: linkPhysicalAsset()
        Note over LO: â° TIMEOUT (5s)
        LO--xCO: TIMEOUT ERROR
        Note right of LO: t=5075ms âŒ
        
        CO->>CO: Detect failure
        CO->>CO: Partial commit
        Note right of CO: Asset saved, link pending
        
        CO->>DLQ: Queue retry job
        DLQ-->>CO: {jobId, retryAt}
        
        CO->>CO: Audit log (PARTIAL)
        CO-->>C: 202 Accepted
        Note right of C: t=5100ms âš ï¸
    end

    Note over C,DLQ: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ASYNC RECOVERY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    rect rgb(245, 158, 11, 0.1)
        loop Retry 1-5 (exponential backoff)
            DLQ->>CO: Retry linkPhysicalAsset
            CO->>LO: linkPhysicalAsset()
            
            alt Success
                LO-->>CO: {lockerId} âœ“
                CO->>LE: updateStatus("linked")
                CO->>C: Webhook: asset.linked
                Note over CO: Recovery complete âœ…
            else Failure
                LO--xCO: ERROR
                CO->>DLQ: Reschedule (+backoff)
            end
        end
        
        Note over DLQ: After 5 failures
        DLQ->>DLQ: Move to dead letter
        DLQ->>CO: Alert operations ğŸš¨
    end
